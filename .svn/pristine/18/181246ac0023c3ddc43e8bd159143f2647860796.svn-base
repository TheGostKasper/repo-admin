
@{
    ViewBag.Title = "ShopperMap";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    #ShopperMap {
        height: 535px;
        /*height: 100%;*/
        width: 100%;
    }

    .ovf {
        max-height: 780px;
        overflow-x: hidden;
    }

    .orderList {
        list-style-type: none;
        padding: 1px;
    }

        .orderList li {
            padding: 10px;
            color: white;
            text-align: center;
            font-size: 23px;
            border-radius: 6px;
            cursor: pointer;
            margin: 2px;
        }

    .Online {
        background: #32c787;
    }

    .Offline {
        background: #dfdfdf;
    }

    span.status {
        padding: 6px;
        color: white;
        border-radius: 50% !important;
    }

    #sOrd {
        width: 100%;
        padding: 13px;
        border-radius: 4px;
        margin-bottom: 7px;
        font-size: 15px;
    }

    .ord-hide {
        display: none;
    }

    .ordh {
        padding: 11px;
        text-align: center;
        font-size: 23px;
        background: white;
    }

    .tit {
        text-align: center;
        font-size: 21px;
    }

    .icon-list {
        padding: 10px;
    }

    .profile_info {
        /*min-height: 260px;*/
    }

    .u-card {
        margin-top: 15px;
        border-radius: 10px;
    }

    .hidden {
        display: none;
    }

    .user__img {
        border-radius: 0px;
    }

    .ord-shn {
        padding: 14px;
        background: #f2de9d;
        color: #3e95cd;
        width: 23%;
        border-radius: 8px;
    }
</style>

<div class="ordh" style="margin-bottom:2px;">
    Select Shopper to track
</div>
<div class="row">
    <div class="col col-lg-8 col-md-8">
        <div id="ShopperMap"></div>
    </div>
    <div class="col col-lg-4 col-md-4">
        <div class="orderListContainer">
            <div class="row">
                <div class="col col-12">
                    <input type="text" class="form-control text-center" name="name" value="" placeholder="Search Order" id="sOrd" />
                </div>
                <div class="col col-12">
                    <div class="card ovf">
                        <div class="card-block">
                            <div class="listview listview--hover list-unstyled orderList">
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

@section scripts{
    <script>
        (function () {
            var shopperApi = getShopperHostUrl(), total = 0, shopCoords = [], originLatLng, destinationLatLng;
            var coords = { lat: 29.964516199999995, lng: 31.2474425 }, shoppers = [];
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var globShopperId = prevShopperId = 0, cuShp;

            var map = new google.maps.Map(document.getElementById('ShopperMap'), {
                zoom: 18,
                center: coords,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                streetViewControl: false
            });
            var geocoder = new google.maps.Geocoder;
            var marker, merchMarker, custMarker;
            marker = new google.maps.Marker({
                draggable: true,
                icon: {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    strokeColor: 'red',
                    strokeWeight: 3,
                    scale: 6,
                },
                map: map,
                duration: 1000
            });
            merchMarker = new google.maps.Marker({
                //position: { lat: _coord.latitude, lng: _coord.longitude },
                draggable: true,
               // icon: '/admin/content/images/supermarket-icon.png',
                map: map
            });
            custMarker = new google.maps.Marker({
                //position: { lat: _coord.latitude, lng: _coord.longitude },
               // icon: '/admin/content/images/Users.png',
                draggable: true,
                map: map
            });


            //var routes_view = [], lnth = 0, cuShp;
            $(document).on('click', '.status', function (e) {
                if (routes_view)
                    var interv = setInterval(function () {
                        if (lnth < routes_view.length) {
                            //callAjax('coordinates', 'POST', {
                            //    shopperId: 1,
                            //    latitude: routes_view[lnth].lat(),
                            //    longitude: routes_view[lnth].lng()
                            //}).done(function (response) {
                            //    console.log(response);
                            //}).fail(function (err) {
                            //});
                            lnth++;
                            marker.setIcon({
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                strokeColor: 'yellow',
                                strokeWeight: cuOrd.courierId,
                                scale: 6,
                                rotation: google.maps.geometry.spherical.computeHeading(marker.getPosition(), new google.maps.LatLng(routes_view[lnth].lat(), routes_view[lnth].lng()))
                            });
                            console.log(routes_view[lnth].lat(), routes_view[lnth].lng());
                            marker.setPosition(new google.maps.LatLng(routes_view[lnth].lat(), routes_view[lnth].lng()));
                        } else {
                            clearInterval(interv);
                        }
                    }, 1000);
            });


            notificationHub.client.watchShopper = function (id, lat, lng) {
                console.log(id, lat, lng);
                if (globShopperId == id)
                    if (marker) {
                        marker.setIcon({
                            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                            strokeColor: 'red',
                            strokeWeight: 3,
                            scale: 6,
                            rotation: google.maps.geometry.spherical.computeHeading(marker.getPosition(), new google.maps.LatLng(lat, lng))
                        });
                        marker.setPosition(new google.maps.LatLng(lat, lng));
                        map.setCenter(new google.maps.LatLng(lat, lng));

                        originLatLng = new google.maps.LatLng(lat, lng);
                        //calculateAndDisplayRoute(directionsService, directionsDisplay);
                    }
            }
            directionsDisplay.setMap(map);
            function calculateAndDisplayRoute(directionsService, directionsDisplay) {
                console.log(originLatLng.lat(), destinationLatLng);
                directionsService.route({
                    origin: originLatLng,
                    destination: destinationLatLng,
                    travelMode: 'DRIVING'
                }, function (response, status) {
                    routes_view = response.routes[0].overview_path;
                    if (status === 'OK') {
                        directionsDisplay.setDirections(response);
                    } else {
                        console.log('Directions request failed due to ' + status);
                    }
                });
            }

            $(document).on('click', '.listview__heading a', function () {
                if (globShopperId == $(this).data('id')) return;

                var _this = $(this);
                globShopperId = $(this).data('id');
                $('.listview__heading a').parent().parent().css('background', '#fefefe');
                _this.parent().parent().css('background', '#f2de9d');
                cuShp = getShopper(globShopperId);

                merchMarker.setMap(null);
                custMarker.setMap(map);
                custMarker.setPosition(new google.maps.LatLng(cuShp.latitude, cuShp.longitude));
                //destinationLatLng = new google.maps.LatLng(cuShp.latitude, cuShp.longitude);
                addWatcher();
                console.log(cuShp);
                map.setCenter(new google.maps.LatLng(cuShp.latitude, cuShp.longitude));

                $('.ordh').addClass('ord-hide');
                $('.profile_info').removeClass('ord-hide');

            });
            function addWatcher() {
                originLatLng = new google.maps.LatLng(cuShp.latitude, cuShp.longitude);
                marker.setPosition(originLatLng);
                // calculateAndDisplayRoute(directionsService, directionsDisplay);
            }

            function getShopper(id) {
                return $.grep(shoppers, function (e) { return e.id == id; })[0];
            }

            $('#sOrd').on('keypress', function (evt) {
                var val = $(this).val();
                if ((evt.which < 48 || evt.which > 57)) {
                    evt.preventDefault();
                }
                else if (val.toString().length === 3 && evt.which != 8 && val.indexOf('-') < 0) {
                    $(this).val(val + '-');
                }
                if (evt.which == 13) {
                    searchOrder($('#sOrd').val());
                }
            });
            $('#sOrd').keydown(function (evt) {
                if (evt.keyCode == 8) {
                    if ($('#sOrd').val().length == 1) drawShoppers(shoppers, $('.orderList'));
                }
            });

            function getShoppers() {
                callAjax('shoppers', 'GET', {})
                    .done(function (response) {
                        if (response.data) {
                            //total = response.data.total;
                            shoppers = response.data;
                            console.log(shoppers);
                            drawShoppers(shoppers, $('.orderList'));
                        }
                    })
                    .fail(function (err) { console.log(err); });
            }
            function drawShoppers(shoppers, container) {
                if (shoppers.length > 0) {
                    container.empty();
                    for (var i = 0; i < shoppers.length; i++) {
                        var ord = shoppers[i];
                        container.append(
                            '<div class= "listview__content oactivity "><div class="listview__heading title">' +
                                   ' <a data-id=' + ord.id + ' data-state="' + ord.status + '" style="font-weight: 600;cursor: pointer; color: #3e95cd;font-size: 20px;"> ' + ord.firstName + ' ' + ord.lastName + ' </a>'
                                    + '<span class ="status right label-warning ' + ord.status + '" ></span></div>' +
                                '<p><span style="font-style:normal;"> ' + ord.mobile + '</span></p></div> '
                            );
                    }
                } else {
                    alert('Order number doesn\'t exist')
                }

            }
            function callAjax(endPoint, type, data) {
                return $.ajax({
                    url: shopperApi + endPoint,
                    type: type,
                    data: data,
                    headers: requestHeaders(),
                    dataType: "json",
                });
            }

            function getShopperHostUrl() {
                // return 'https://www.weelo.com.eg/api/shopper/';

                if (isWebsiteLive) return 'https://www.weelo.com.eg/api/shopper/';
                else
                    return '/api/shopper/';
            }
            function init() {
                getShoppers();
            }
            init();
        }());
    </script>
}

